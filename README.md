# Проект системы распознавания номера платёжной карты

## Основные этапы проекта
 - Генерация обучающего датасета цифр размером 32х32 пикселя по двум шаблонам шрифтов цифр, используемых на кредитных картах ([datacreator](./src/datacreator.py)). Для увеличения вариативности датасета использовалась библиотека аугментации данных albumentations;
 - Подготовка скрипта, содержащего реализацию класса для загрузки данных для обучения ([dataset](./src/dataloader.py));
 - Подготовка скрипта, содержащего класс архитектуры модели, класс, реализующий обучение модели, и класс, выполняющий инференс ([model](./src/nnet.py));
 - Обучение модели на различных датасетах с последующим сохранением ([learning](./src/main_learning.py));
 - Класс, реализующий предварительную обработку изображения кредитной карты для подачи в модель для инференса ([image_proc](./src/card_image_proc.py))
 - Функционал для предсказания модели [(inference](./src/main_infer.py)).

## Краткое изложение проекта и выводы

### Датасет
 - Т.к. в свободном доступе находится небольшое количество изображений цифр с кредитных карт (например, https://www.kaggle.com/datasets/barbaravanaki/credit-card-number-images содержит всего 885 изображений, распределённых по десяти классам), было решено сгенерировать обучающий датасет искусственно.
 - Датасет генерировался на основе двух шаблонов шрифтов цифр, используемых на кредитных картах.
 - Сгенерированный датасет содержит 80000 обучающих изображений - по 4000 изображений для каждого из двух типов шрифтов для десяти классов цифр; 20000 валидационных изображений и 10000 тестовых.
 - Класс создания датасета предусматривает как простое размножение изображений цифр, так и их аугментацию - аффинный преобразования (масштабирование, повороты и т.д.), размытие и т.д.
 - Для тестирования модели были использованы шаблонные изображения кредитных карт

### Модель
 - В задаче была использована модель свёрточной нейронной сети типа vgg. После трёх свёрточных каскадов, выделяющих признаки и содержащих по два свёрточных слоя с 32-мя фильтрами формы (3,3) и завершающихся слоем макспуллинга с размером маски (2,2), следуют два полносвязных слоя, 
 ответственные за классификацию, после которых идут слои пакетной нормализации и дропаута (p=0.25).
 - Параметры padding и равны единице, поэтому размер изображения уменьшается только за счёт трёх слоёв макспуллинга с
 (32,32) до (4,4).
 - Подобная архитектура была выбрана из-за относительной простоты исследуемых изображений - одноканальные изображения цифр, разбитые на десять классов.
 - Везде были использованы функции активации LeakyReLU, за исключением последнего, классификиционного слоя, где применялась функция активации SoftMax.
 - Функция потерь - CrossEntropyLoss, в данном случае мультиклассовая перекрёстная энтропия.
 - Оптимизатор - Adam, с коэффицентов обучения 1е-5 и параметром weight_decay, отвечающим за регуляризацию, равным 1e-3.
 - Модель принимает на вход изображения одноканальные изображения цифр (GRAYSTYLE) размером (32,32) пикселя.
 - Обучение проводится на всём обучающем датасете с размером батча 128; каждый последующий лучший результат на валидационной выборке директории [models](./models)
 - 

### Метрики
 - Т.к. классы сбалансированы, для валидации была использована метрика accuracy. 
 
### Описание подхода к задаче
Для того, чтобы распознавать цифры номера кредитной карты, необходимо выделить два типа region of interest (RoI) на 
изображении кредитной карты - 
прямоугольную область, где находятся все шестнадцать цифр номера, и шестнадцать прямоугольников, непосредственно 
выделяющих каждую конкретную цифру на первом RoI. Далее, изображение каждой выделенной цифры масштабируется до требудемого 
размера (32,32) пикселя и передаётся в обученную модель, которая предсказывает предполагаемый класс цифр от нуля до девяти.
В задаче использовались методы как классического компьютерного зрения - для выделения RoI, так и глубокое обучение для 
непосредственного распознавания цифр. Для выделения RoI изпользованись следующие методы:
 - изменения формы изображения кредитной карты;
 - дополнение границами со всех сторон (необходимо для последующей морфологической обработки);
 - бинаризация изображения с последующей морфологической операцией замыкания (эрозия дилатации) для устранения всех 
 пустот внутри изображения кредитной карты;
 - выделение контура кредитной карты на изображении и определение точек её углом;
 - выполнение perspective transformation для приведения изображений карт к заранее заданному шаблону - как буд-то мы смотрим
 на них сверху под прямым углом. Шаблон является прямоугольником со следующими координатами: левый верхний угол имеет координаты
 (0,0), правый нижний - (690,430).
 - далее, на полученной шаблоне выделяется RoI, содержащий все шестнадцать цифр, затем из него выделяются 
 шестнадцать прямоугольников, содежжащих каждую отдельную цифру.
 - форма изображений цифр изменяется до (32,32), затем они передаётся в модель.
 
 Что касается модели, то для распознавания цифр на изображениях была использована свёрточная сеть архитектуры типа vgg
 для классификации по десяти классам, обученная на синтетическом наборе данных, который был получен  путём генерации изображений цифр
 по двум заданным шаблонам с применением поворотов размытия и т.д. 
 

### Результаты
Результаты работы алгоритма в целом логгируются в текстовый файлы, лежащие в соответствующей директории ([logs](./logs)).
В свою очередь предсказания модели пишутся в файл [predict](./predict.log) в корневой директории проекта. Туда заносятся:
 - название файла изображения кредитной карты;
 - список с её номером;
 - список предсказанных цифр номера карты.

Результаты работы модели являются удовлетворительными - на шаблонных изображениях кредитный карт около 97% цифр было распознано
правильно.

Отмечу, несколько моментов:
 - модель периодически путает цифру 5 с цифрой 2, как, например, на изображении [cc03.png](./data_for_test/cc03.png).
 Возможно, есть необходимость дополнительно обогатить данные этих классов, например, вертикальным отражением изображения
 для увеличения обощающей способносте модели или
 поиграть с её параметра, например, коэффициентом регуляризации или вероятностью дропаута.
 - Из-за изначально малого размера изображения [bankOfCommYanChai.jpg](./data_for_test/bankOfCommYanChai.jpg), при увеличении его формы
 пострадало качество после интерполяции. По этой причине контуры третьей и четвёртой цифр слились, что не дало возможности
 выделить их отдельно. Они были пропущены, однако оставшиеся цифры распознались правильно. Это большая проблема всего подхода,
 основанного на алгоритмах классического компьютерного зрения, что будет отмечено в выводах.

### Рекомендации по дальнейшему развитию задачи

Необходимо отказаться от этапа получения RoI, используя подход классического компьютерного зрения. Это связано с несколькими причинами:
 - подход, связанный с компьютерным зрением очень зависим от качества изображения - при плохом качестве контуры цифр будут слипаться
 и их не получится выделить по отдельности.
 - если прошлая проблема решается увеличением изначального качетсва изображений, то вариативность расцветок и рисунков на самих
 кредитных картах делает задачу, скорее всего нерешаемой в общем виде для произвольных, наперёд заданных карт. Например, по цифрам может проходить
 рисунок фона. Если для каждой конкретной карты цифры ещё можно попытаться выдилить, например, исследуя каждый цветовой канал, то автоматизировать
 этот процесс для любой карты не представляется возможным. Также цифры номера карты могут иметь цвет фона (в этом случае, 
 иногда, даже человеческому глазу бывает трудно быстро распознать цифры) - тогда задача, опять же, становиться трудноразрешимой
 и автоматизация такого процесса невозможна.
 
По этой причине стоит использовать подход, полностью основанный на глубоком обучении:
 - создать дадасет, на котором прямоугольниками будут размечены все шестнадцать RoI, содержащие интересующие цифры номера карты.
 При этом, желательно, чтобы изображения карт удовлетворяли некоторому шаблону. 
 - далее, первая модель учится определять местоположения всех RoI - по сути решая задачу регресии, определяя, например,
 координаты левого верхнего и правого нижнего углов ограничивающего прямоугольника для каждого из шестнадцати RoI - всего
 64 значения.
 - вторая модель, по примеру обученной здесь, получает на вход RoI от первой модели и проводит распознавание цифр номер карты.

### Состав проекта
 - [data_for_test](./data_for_test) содержит изображения кредитных карт для тестирования модели;
 - [digit_examples](./digit_examples) содержит примеры шрифтом цифр, используемых на кредитных картах;
 - [logs](./logs) содержит логи;
 - [models](./models) директория, где сохраняются обученные модели;
 - [parameters](./parameters) директория, где лежат .yaml-файлы с параметрами:
    - [parameters_datacreator](./parameters/parameters_datacreator.yml) содержит параметры для скрипта генерации датасета:
	   - path_to_examples1: путь к первому примеру шрифта
	   - path_to_examples2: путь ко второму примеру шрифта
       - tr_data_path: путь, где сохраняться обучающие данные
       - val_data_path: путь, где сохраняться валидационные данные
       - test_data_path: путь, где сохраняться тестовые данные
       - train_size: количество экземпляров для каждого класса на каждый шрифт для обучающих данных
       - val_size: количество экземпляров для каждого класса на каждый шрифт для валидационных данных
       - test_size: количество экземпляров для каждого класса на каждый шрифт для тестовых данных
	   - simple_aug: параметр, отвечающий за то, необходимо ли делать аугментацию данных
       - dim: размер генерируемого изображения (dim, dim)
	- [parameters_learning](./parameters/parameters_learning.yml) содержит параметры для скрипта обучения модели:
	   - data_path: путь к данным
       - model_path: путь, по которому сохраняется обученная модель
       - model_name: название модели
       - batch_size: размер батча
       - dropout: вероятность дропаута нейронов
       - nn_type: тип модели
       - device: тип устройства, на котором будет проходит обучение
       - EPOCHS: количество эпох
       - need_transform: параметр, указывающий необходимо ли делать нормализацию данных
	- [parameters_infer](./parameters/parameters_infer.yml) содержит параметры для скрипта инференса:
	   - path_to_model: путь к сохранённой модели
       - path_to_data: путь к изображению для инференса модели
       - nn_type: тип модели
       - dropout: вероятность дропаута нейронов
       - device: тип устройства, на котором будет будет происходить расчёт
       - need_transform: параметр, указывающий необходимо ли делать нормализацию данных
 - [src](./src) содержит скрипты:
    - [datacreator](./src/datacreator.py) скрипт, генерирующий датасет по шаблонам шрифтов
	- [dataloader](./src/dataloader.py) скрипт, содержащий стандартный класса загрузки данных, требуемый в pytorch
	- [nnet](./src/nnet.py) скрипт, содержащий класс архитектуры модели, и два класса, реализующих обучение и инференс
	- [card_image_proc](./src/card_image_proc.py) класс, реализующий предварительную обработку изображения кредитной карты для последующей передачи его в класс для инференса
	- [main_learning](./src/main_learning.py) скрипт для запуска процесса обучения модели
	- [main_infer](./src/main_infer.py) скрип для инференса

